<div class="cronometro-container">
  <div class="card">
    <h3 class="card-title">üïí Cron√¥metro de Estudos</h3>

    <div class="timer">{{ tempo }}</div>

    <!-- CATEGORIA -->
    <div class="form-group" *ngIf="!sessaoAtiva">
      <label for="categoria">Categoria: <span class="campo-obrigatorio">*</span></label>
      <select 
        id="categoria"
        class="form-control select-estudo"
        aria-required="true"
        [ngClass]="{'is-invalid': erro && !categoriaId}"
        [disabled]="sessaoAtiva || carregando"
        [(ngModel)]="categoriaId"
        (ngModelChange)="selecionarCategoria($event)">
        <option [ngValue]="null">Selecione uma categoria</option>
        <option *ngFor="let cat of categorias" [ngValue]="cat.id">{{ cat.nome }}</option>
      </select>
      <div *ngIf="erro && !categoriaId" class="campo-erro">Selecione uma categoria</div>
    </div>

    <!-- MAT√âRIA -->
    <div class="form-group" *ngIf="!sessaoAtiva">
      <label for="materia">Mat√©ria: <span class="campo-obrigatorio">*</span></label>
      <select 
        id="materia"
        class="form-control select-estudo"
        aria-required="true"
        [ngClass]="{'is-invalid': erro && categoriaId && !materiaId}"
        [disabled]="sessaoAtiva || !categoriaId || carregando || materiasFiltradas.length === 0"
        [(ngModel)]="materiaId"
        (ngModelChange)="selecionarMateria($event)">
        <option [ngValue]="null">Selecione uma mat√©ria</option>
        <option *ngFor="let mat of materiasFiltradas" [ngValue]="mat.id">{{ mat.nome }}</option>
      </select>
      <div *ngIf="categoriaId && materiasFiltradas.length === 0" class="form-hint">N√£o h√° mat√©rias dispon√≠veis para esta categoria</div>
      <div *ngIf="erro && categoriaId && !materiaId" class="campo-erro">Selecione uma mat√©ria</div>
    </div>

    <!-- T√ìPICO -->
    <div class="form-group" *ngIf="!sessaoAtiva">
      <label for="topico">T√≥pico: <span class="campo-obrigatorio">*</span></label>
      <select 
        id="topico"
        class="form-control select-estudo"
        aria-required="true"
        [ngClass]="{'is-invalid': erro && materiaId && !topicoId && topicosFiltrados.length > 0}"
        [disabled]="sessaoAtiva || !materiaId || carregando || topicosFiltrados.length === 0"
        [(ngModel)]="topicoId">
        <option [ngValue]="null">{{ topicosFiltrados.length > 0 ? 'Selecione um t√≥pico' : 'Nenhum t√≥pico dispon√≠vel' }}</option>
        <option *ngFor="let top of topicosFiltrados" [ngValue]="top.id">{{ top.nome }}</option>
      </select>
      <div *ngIf="erro && materiaId && !topicoId && topicosFiltrados.length > 0" class="campo-erro">Selecione um t√≥pico</div>
    </div>

    <!-- INFORMA√á√ïES DA SESS√ÉO -->
    <div class="info-sessao fade-in" *ngIf="sessaoAtiva">
      <div class="categoria-materia">
        <span class="categoria">{{ obterNomeCategoria(categoriaId) }}</span>
        <span class="materia">{{ obterNomeMateria(materiaId) }}</span>
        <span class="topico" *ngIf="topicoId">- {{ obterNomeTopico(topicoId) }}</span>
      </div>
    </div>

    <!-- BOT√ïES -->
    <div class="controles-timer">
      <button 
        class="btn btn-primary"
        title="Iniciar o cron√¥metro"
        (click)="iniciar()"
        [disabled]="carregando || sessaoAtiva || !categoriaId || !materiaId || (!topicoId && topicosFiltrados.length > 0)">
        ‚ñ∂Ô∏è Iniciar
      </button>

      <button 
        class="btn"
        title="Pausar ou retomar a sess√£o"
        [ngClass]="{'btn-warning': !sessaoPausada, 'btn-info': sessaoPausada}"
        (click)="pausar()"
        [disabled]="carregando || !sessaoAtiva">
        {{ sessaoPausada ? 'üîÑ Retomar' : '‚è∏Ô∏è Pausar' }}
      </button>

      <button 
        class="btn btn-danger"
        title="Finalizar a sess√£o"
        (click)="parar()"
        [disabled]="carregando || !sessaoAtiva">
        ‚õî Finalizar
      </button>
    </div>

    <!-- ANOTA√á√ïES -->
    <div class="campo-notas fade-in" *ngIf="sessaoAtiva">
      <label for="notas">üìì Anota√ß√µes:</label>
      <textarea 
        id="notas"
        class="form-control"
        placeholder="Adicionar notas..." 
        [(ngModel)]="notas"
        (input)="onNotasChange()"
        (blur)="salvarNotas()"
        rows="3">
      </textarea>
      <div class="notas-info">
        <small class="text-muted" *ngIf="notas !== ultimasNotas">üíæ Salvando...</small>
        <small class="text-success" *ngIf="notas === ultimasNotas && notas">‚úÖ Notas salvas</small>
      </div>
    </div>

    <!-- STATUS -->
    <div class="cronometro-status fade-in" *ngIf="sessaoAtiva">
      <div class="status" [ngClass]="{'status-ativo': !sessaoPausada, 'status-pausado': sessaoPausada}">
        {{ sessaoPausada ? '‚è∏Ô∏è Pausado' : '‚úÖ Em andamento' }}
      </div>
    </div>

    <!-- ERRO -->
    <div class="mensagem-erro fade-in" *ngIf="erro">
      <div class="alert alert-danger">
        ‚ùó {{ erro }}
      </div>
    </div>

    <!-- CARREGANDO -->
    <div class="loading-indicator fade-in" *ngIf="carregando">
      <div class="spinner"></div>
      <span>‚è≥ Carregando...</span>
    </div>
  </div>

  <!-- Modal de Retorno -->
<div class="modal-overlay fade-in" *ngIf="mostrarModalRetorno">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Sess√£o de Estudos Pausada</h4>
      </div>
      <div class="modal-body">
        <p>Sua sess√£o de estudos foi pausada automaticamente porque voc√™ fechou a p√°gina ou perdeu a conex√£o com a internet.</p>
        <p>O que deseja fazer agora?</p>
        
        <div class="sessao-info">
          <p><strong>Categoria:</strong> {{ obterNomeCategoria(categoriaId) }}</p>
          <p><strong>Mat√©ria:</strong> {{ obterNomeMateria(materiaId) }}</p>
          <p *ngIf="topicoId"><strong>T√≥pico:</strong> {{ obterNomeTopico(topicoId) }}</p>
          <p><strong>Tempo decorrido:</strong> {{ tempo }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" (click)="finalizarSessaoRetorno()">
          Finalizar Sess√£o
        </button>
        <button class="btn btn-primary" (click)="continuarSessao()">
          Continuar Estudando
        </button>
      </div>
    </div>
  </div>
</div>
</div>
